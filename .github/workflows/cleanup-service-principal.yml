name: 3Ô∏è‚É£ Cleanup Service Principal (One-Time)

on:
  workflow_dispatch:
    inputs:
      servicePrincipalName:
        description: 'Service Principal Name to delete'
        required: true
        default: 'sp-github-oidc-setup'
      confirmDeletion:
        description: 'Type DELETE to confirm deletion'
        required: true

permissions:
  contents: read

jobs:
  cleanup-service-principal:
    runs-on: ubuntu-latest
    
    steps:
      - name: ‚úÖ Validar confirma√ß√£o
        run: |
          if [ "${{ github.event.inputs.confirmDeletion }}" != "DELETE" ]; then
            echo "‚ùå ERRO: Confirma√ß√£o inv√°lida"
            echo ""
            echo "Para deletar o Service Principal, voc√™ deve:"
            echo "1. Digite exatamente: DELETE"
            echo "2. Execute novamente este workflow"
            echo ""
            echo "‚ö†Ô∏è  IMPORTANTE: Certifique-se de que:"
            echo "   ‚úÖ Os 3 secrets OIDC j√° est√£o configurados:"
            echo "      - AZURE_CLIENT_ID"
            echo "      - AZURE_TENANT_ID"
            echo "      - AZURE_SUBSCRIPTION_ID"
            echo "   ‚úÖ Voc√™ testou o workflow '1Ô∏è‚É£ Deploy Infrastructure' com OIDC"
            echo ""
            exit 1
          fi
          
          echo "‚úÖ Confirma√ß√£o v√°lida, prosseguindo com limpeza..."
      
      - name: üîê Login no Azure com Service Principal
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_SETUP_CREDENTIALS }}
      
      - name: üîç Verificar Service Principal
        id: check_sp
        run: |
          echo "üîç Procurando Service Principal: ${{ github.event.inputs.servicePrincipalName }}"
          
          SP_INFO=$(az ad sp list --display-name "${{ github.event.inputs.servicePrincipalName }}" --query "[0].{AppId:appId, DisplayName:displayName, ObjectId:id}" -o json)
          
          if [ "$SP_INFO" == "null" ] || [ -z "$SP_INFO" ]; then
            echo "‚ö†Ô∏è  Service Principal n√£o encontrado"
            echo "   Nome buscado: ${{ github.event.inputs.servicePrincipalName }}"
            echo ""
            echo "Poss√≠veis causas:"
            echo "1. J√° foi deletado anteriormente"
            echo "2. Nome incorreto (verifique o nome usado na cria√ß√£o)"
            echo "3. Voc√™ n√£o tem permiss√£o para visualizar"
            echo ""
            echo "sp_exists=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          APP_ID=$(echo "$SP_INFO" | jq -r '.AppId')
          DISPLAY_NAME=$(echo "$SP_INFO" | jq -r '.DisplayName')
          OBJECT_ID=$(echo "$SP_INFO" | jq -r '.ObjectId')
          
          echo "‚úÖ Service Principal encontrado:"
          echo "   Display Name: $DISPLAY_NAME"
          echo "   App ID: $APP_ID"
          echo "   Object ID: $OBJECT_ID"
          echo ""
          
          echo "sp_exists=true" >> $GITHUB_OUTPUT
          echo "app_id=$APP_ID" >> $GITHUB_OUTPUT
      
      - name: üóëÔ∏è Deletar Service Principal
        if: steps.check_sp.outputs.sp_exists == 'true'
        run: |
          echo "üóëÔ∏è  Deletando Service Principal..."
          
          az ad sp delete --id ${{ steps.check_sp.outputs.app_id }}
          
          echo "‚úÖ Service Principal deletado com sucesso!"
          echo ""
          echo "App ID deletado: ${{ steps.check_sp.outputs.app_id }}"
      
      - name: üìã Pr√≥ximos passos
        run: |
          echo "====================================="
          echo "   ‚úÖ LIMPEZA CONCLU√çDA!            "
          echo "====================================="
          echo ""
          
          if [ "${{ steps.check_sp.outputs.sp_exists }}" == "true" ]; then
            echo "‚úÖ Service Principal foi deletado com sucesso"
            echo ""
            echo "üìã PR√ìXIMOS PASSOS:"
            echo ""
            echo "1. Delete o secret AZURE_SETUP_CREDENTIALS do GitHub:"
            echo "   https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo ""
            echo "2. A partir de agora, todos os deploys usar√£o OIDC (mais seguro)"
            echo ""
            echo "3. Execute os workflows de deploy:"
            echo "   ‚ñ∂Ô∏è  1Ô∏è‚É£ Deploy Infrastructure"
            echo "   ‚è∞ Aguarde 2-3 minutos"
            echo "   ‚ñ∂Ô∏è  2Ô∏è‚É£ Activate Container App"
            echo ""
            echo "üéâ Setup enterprise completo!"
          else
            echo "‚ö†Ô∏è  Service Principal n√£o foi encontrado (pode j√° ter sido deletado)"
            echo ""
            echo "‚úÖ Voc√™ pode prosseguir com os deploys usando OIDC"
          fi
          echo ""
