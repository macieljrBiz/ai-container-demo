name: 1Ô∏è‚É£ Deploy Infrastructure

on:
  workflow_dispatch:
    inputs:
      resourceGroupName:
        description: 'Nome do Resource Group'
        required: true
        default: 'rg-ai-container-demo'
      containerAppName:
        description: 'Nome do Container App'
        required: true
        default: 'ai-container-app'
      acrName:
        description: 'Nome do Azure Container Registry'
        required: true
      azureOpenAIEndpoint:
        description: 'Endpoint do Azure OpenAI (ex: https://seu-modelo.openai.azure.com/)'
        required: true
      azureOpenAIDeployment:
        description: 'Nome do deployment do Azure OpenAI'
        required: true
        default: 'gpt-4o'
      openAiResourceId:
        description: 'Resource ID completo do Azure OpenAI'
        required: true

permissions:
  id-token: write   # Required for OIDC authentication
  contents: read

jobs:
  deploy-bicep:
    name: Deploy Bicep Template
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîê Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: üì¶ Create Resource Group
        run: |
          az group create \
            --name ${{ github.event.inputs.resourceGroupName }} \
            --location brazilsouth

      - name: üöÄ Deploy Bicep Template
        run: |
          az deployment group create \
            --resource-group ${{ github.event.inputs.resourceGroupName }} \
            --template-file infrastructure/container-app-complete.bicep \
            --parameters \
              containerAppName='${{ github.event.inputs.containerAppName }}' \
              acrName='${{ github.event.inputs.acrName }}' \
              azureOpenAIEndpoint='${{ github.event.inputs.azureOpenAIEndpoint }}' \
              azureOpenAIDeployment='${{ github.event.inputs.azureOpenAIDeployment }}' \
              openAiResourceId='${{ github.event.inputs.openAiResourceId }}'

      - name: ‚úÖ Deployment Complete
        run: |
          echo "‚úÖ Infraestrutura deployada com sucesso!"
          echo ""
          echo "üìã Pr√≥ximos passos:"
          echo "1. Aguardar 2-3 minutos para propaga√ß√£o de permiss√µes"
          echo "2. Executar workflow '2Ô∏è‚É£ Activate Container App'"
          echo ""
          echo "‚ÑπÔ∏è Container App criado com minReplicas=0 (inativo)"
          echo "   Ser√° ativado pelo pr√≥ximo workflow ap√≥s propaga√ß√£o de roles"
