name: 2ï¸âƒ£ Activate Container App

on:
  workflow_dispatch:
    inputs:
      resourceGroupName:
        description: 'Nome do Resource Group'
        required: true
        default: 'rg-ai-container-demo'
      containerAppName:
        description: 'Nome do Container App'
        required: true
        default: 'ai-container-app'
      waitTimeMinutes:
        description: 'Tempo de espera em minutos (recomendado: 2-3)'
        required: true
        default: '2'

permissions:
  id-token: write   # Required for OIDC authentication
  contents: read

jobs:
  activate-app:
    name: Wait and Activate Container App
    runs-on: ubuntu-latest
    
    steps:
      - name: â±ï¸ Wait for Role Propagation
        run: |
          WAIT_SECONDS=$((${{ github.event.inputs.waitTimeMinutes }} * 60))
          echo "â³ Aguardando ${{ github.event.inputs.waitTimeMinutes }} minutos (${WAIT_SECONDS}s) para propagaÃ§Ã£o de permissÃµes..."
          echo ""
          echo "ğŸ“ Durante esse tempo, o Azure estÃ¡:"
          echo "   â€¢ Replicando role assignments globalmente"
          echo "   â€¢ Propagando permissÃµes de AcrPull"
          echo "   â€¢ Propagando permissÃµes de Azure OpenAI"
          echo ""
          
          for i in $(seq 1 ${{ github.event.inputs.waitTimeMinutes }}); do
            echo "â° Minuto $i de ${{ github.event.inputs.waitTimeMinutes }}..."
            sleep 60
          done
          
          echo "âœ… Tempo de espera concluÃ­do!"

      - name: ğŸ” Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: ğŸš€ Activate Container App
        run: |
          echo "ğŸ”„ Ativando Container App..."
          az containerapp update \
            --name ${{ github.event.inputs.containerAppName }} \
            --resource-group ${{ github.event.inputs.resourceGroupName }} \
            --min-replicas 1 \
            --output none
          
          echo "âœ… Container App ativado com sucesso!"

      - name: ğŸ“Š Get Container App URL
        run: |
          FQDN=$(az containerapp show \
            --name ${{ github.event.inputs.containerAppName }} \
            --resource-group ${{ github.event.inputs.resourceGroupName }} \
            --query 'properties.configuration.ingress.fqdn' \
            --output tsv)
          
          echo ""
          echo "ğŸ‰ Deployment completo!"
          echo "ğŸŒ URL do Container App: https://${FQDN}"
          echo ""
          echo "ğŸ§ª Teste a API:"
          echo "   curl https://${FQDN}/responses"
