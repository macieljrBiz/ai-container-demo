name: 0Ô∏è‚É£ Setup OIDC (One-Time Setup)

on:
  workflow_dispatch:
    inputs:
      githubOrg:
        description: 'GitHub Organization/Owner'
        required: true
        default: 'AndressaSiqueira'
      githubRepo:
        description: 'GitHub Repository'
        required: true
        default: 'Webapp'
      branch:
        description: 'Branch name'
        required: true
        default: 'master'
      resourceGroup:
        description: 'Resource Group for Managed Identity'
        required: true
        default: 'rg-github-actions-oidc'
      location:
        description: 'Azure Location'
        required: true
        default: 'brazilsouth'
      identityName:
        description: 'Managed Identity Name'
        required: true
        default: 'id-github-actions-deploy'

permissions:
  contents: read

jobs:
  setup-oidc:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4
      
      - name: üîê Login no Azure com Service Principal
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_SETUP_CREDENTIALS }}
      
      - name: üîç Obter informa√ß√µes da subscription
        id: subscription
        run: |
          SUBSCRIPTION_ID=$(az account show --query id -o tsv)
          TENANT_ID=$(az account show --query tenantId -o tsv)
          
          echo "subscription_id=$SUBSCRIPTION_ID" >> $GITHUB_OUTPUT
          echo "tenant_id=$TENANT_ID" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Subscription ID: $SUBSCRIPTION_ID"
          echo "‚úÖ Tenant ID: $TENANT_ID"
      
      - name: üì¶ Criar Resource Group
        run: |
          echo "üì¶ Criando Resource Group..."
          
          if az group exists --name ${{ github.event.inputs.resourceGroup }} | grep -q "true"; then
            echo "‚ö†Ô∏è  Resource Group j√° existe, usando existente"
          else
            az group create \
              --name ${{ github.event.inputs.resourceGroup }} \
              --location ${{ github.event.inputs.location }} \
              --output none
            echo "‚úÖ Resource Group criado"
          fi
      
      - name: üÜî Criar Managed Identity
        id: identity
        run: |
          echo "üÜî Criando Managed Identity..."
          
          if az identity show \
            --name ${{ github.event.inputs.identityName }} \
            --resource-group ${{ github.event.inputs.resourceGroup }} &> /dev/null; then
            echo "‚ö†Ô∏è  Managed Identity j√° existe, usando existente"
          else
            az identity create \
              --name ${{ github.event.inputs.identityName }} \
              --resource-group ${{ github.event.inputs.resourceGroup }} \
              --location ${{ github.event.inputs.location }} \
              --output none
            echo "‚úÖ Managed Identity criada"
          fi
          
          # Obter Client ID e Principal ID
          CLIENT_ID=$(az identity show \
            --name ${{ github.event.inputs.identityName }} \
            --resource-group ${{ github.event.inputs.resourceGroup }} \
            --query clientId -o tsv)
          
          PRINCIPAL_ID=$(az identity show \
            --name ${{ github.event.inputs.identityName }} \
            --resource-group ${{ github.event.inputs.resourceGroup }} \
            --query principalId -o tsv)
          
          echo "client_id=$CLIENT_ID" >> $GITHUB_OUTPUT
          echo "principal_id=$PRINCIPAL_ID" >> $GITHUB_OUTPUT
          
          echo "   Client ID: $CLIENT_ID"
          echo "   Principal ID: $PRINCIPAL_ID"
      
      - name: üîê Atribuir Role: Contributor
        run: |
          echo "üîê Atribuindo Role: Contributor..."
          
          # Verificar se j√° existe
          if az role assignment list \
            --assignee ${{ steps.identity.outputs.principal_id }} \
            --role "Contributor" \
            --scope "/subscriptions/${{ steps.subscription.outputs.subscription_id }}" \
            --query "[0].id" -o tsv 2>/dev/null | grep -q "."; then
            echo "‚ö†Ô∏è  Role Contributor j√° atribu√≠da"
          else
            az role assignment create \
              --assignee ${{ steps.identity.outputs.client_id }} \
              --role "Contributor" \
              --scope "/subscriptions/${{ steps.subscription.outputs.subscription_id }}" \
              --output none
            
            echo "‚úÖ Role Contributor atribu√≠da"
            echo "‚è≥ Aguardando propaga√ß√£o (30s)..."
            sleep 30
          fi
      
      - name: üîê Atribuir Role: User Access Administrator
        run: |
          echo "üîê Atribuindo Role: User Access Administrator..."
          
          # Verificar se j√° existe
          if az role assignment list \
            --assignee ${{ steps.identity.outputs.principal_id }} \
            --role "User Access Administrator" \
            --scope "/subscriptions/${{ steps.subscription.outputs.subscription_id }}" \
            --query "[0].id" -o tsv 2>/dev/null | grep -q "."; then
            echo "‚ö†Ô∏è  Role User Access Administrator j√° atribu√≠da"
          else
            az role assignment create \
              --assignee ${{ steps.identity.outputs.client_id }} \
              --role "User Access Administrator" \
              --scope "/subscriptions/${{ steps.subscription.outputs.subscription_id }}" \
              --output none
            
            echo "‚úÖ Role User Access Administrator atribu√≠da"
            echo "‚è≥ Aguardando propaga√ß√£o (30s)..."
            sleep 30
          fi
      
      - name: üîó Criar Federated Identity Credential
        run: |
          echo "üîó Criando Federated Identity Credential..."
          
          FEDERATED_CRED_NAME="github-actions-federated"
          SUBJECT="repo:${{ github.event.inputs.githubOrg }}/${{ github.event.inputs.githubRepo }}:ref:refs/heads/${{ github.event.inputs.branch }}"
          
          # Verificar se j√° existe
          if az identity federated-credential show \
            --name "$FEDERATED_CRED_NAME" \
            --identity-name ${{ github.event.inputs.identityName }} \
            --resource-group ${{ github.event.inputs.resourceGroup }} &> /dev/null; then
            echo "‚ö†Ô∏è  Federated Credential j√° existe"
            echo "   Deletando credencial existente..."
            
            az identity federated-credential delete \
              --name "$FEDERATED_CRED_NAME" \
              --identity-name ${{ github.event.inputs.identityName }} \
              --resource-group ${{ github.event.inputs.resourceGroup }} \
              --yes \
              --output none
            
            sleep 5
          fi
          
          # Criar credencial
          az identity federated-credential create \
            --name "$FEDERATED_CRED_NAME" \
            --identity-name ${{ github.event.inputs.identityName }} \
            --resource-group ${{ github.event.inputs.resourceGroup }} \
            --issuer "https://token.actions.githubusercontent.com" \
            --subject "$SUBJECT" \
            --audiences "api://AzureADTokenExchange" \
            --output none
          
          echo "‚úÖ Federated Credential criado"
          echo "   Subject: $SUBJECT"
      
      - name: üìã Resumo - Secrets para configurar
        run: |
          echo "====================================="
          echo "   ‚úÖ CONFIGURA√á√ÉO CONCLU√çDA!       "
          echo "====================================="
          echo ""
          echo "üìã SECRETS PARA CONFIGURAR NO GITHUB:"
          echo ""
          echo "V√° para: https://github.com/${{ github.event.inputs.githubOrg }}/${{ github.event.inputs.githubRepo }}/settings/secrets/actions"
          echo ""
          echo "Adicione os seguintes secrets:"
          echo ""
          echo "AZURE_CLIENT_ID"
          echo "${{ steps.identity.outputs.client_id }}"
          echo ""
          echo "AZURE_TENANT_ID"
          echo "${{ steps.subscription.outputs.tenant_id }}"
          echo ""
          echo "AZURE_SUBSCRIPTION_ID"
          echo "${{ steps.subscription.outputs.subscription_id }}"
          echo ""
          echo "====================================="
          echo ""
          echo "‚úÖ Pr√≥ximo passo:"
          echo "   1. Configure os 3 secrets acima no GitHub"
          echo "   2. Delete o secret AZURE_SETUP_CREDENTIALS (n√£o √© mais necess√°rio)"
          echo "   3. Execute o workflow: 3Ô∏è‚É£ Cleanup Service Principal"
          echo "   4. Execute o workflow: 1Ô∏è‚É£ Deploy Infrastructure"
          echo "   5. Aguarde 2-3 minutos"
          echo "   6. Execute o workflow: 2Ô∏è‚É£ Activate Container App"
          echo ""
          echo "üéâ Deploy profissional pronto!"
          echo ""
